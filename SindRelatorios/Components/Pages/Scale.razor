@page "/escalas"
@using SindRelatorios.Models.Entities
@using SindRelatorios.Models.Entities.Enums
@using System.Globalization

<PageTitle>Gestão de Escalas</PageTitle>

<div class="container-fluid p-0">

    <!-- Cabeçalho -->
    <div class="d-flex align-items-center justify-content-between mb-5">
        <div>
            <h3 class="fw-bold text-secondary m-0">Cronograma Anual</h3>
            <small class="text-muted">Visão geral das aberturas de turmas.</small>
        </div>
        <button class="btn btn-primary shadow-sm px-4 py-2 fw-bold" @onclick="NavigateToNew">
            <i class="bi bi-plus-lg me-2"></i> Nova Abertura
        </button>
    </div>

    @if (IsLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status"></div>
        </div>
    }
    else if (!Openings.Any())
    {
        <div class="text-center py-5 text-muted opacity-50">
            <i class="bi bi-calendar-x fs-1"></i>
            <p>Nenhuma escala cadastrada.</p>
        </div>
    }
    else
    {
        <!-- LÓGICA DE AGRUPAMENTO POR MÊS -->
        @foreach (var group in Openings.GroupBy(x => new { x.Date.Month, x.Date.Year }).OrderBy(g => g.Key.Year).ThenBy(g => g.Key.Month))
        {
            var monthName = CultureInfo.CurrentCulture.DateTimeFormat.GetMonthName(group.Key.Month);

            <div class="mb-5 fade-in">
                <!-- Título do Mês -->
                <div class="d-flex align-items-center mb-3">
                    <h5 class="text-uppercase fw-bold text-secondary m-0 me-3">@monthName @group.Key.Year</h5>
                    <div class="flex-grow-1 border-bottom"></div>
                </div>

                <!-- Grid de Cards -->
                <div class="row g-3">
                    @foreach (var item in group.OrderBy(x => x.Date))
                    {
                        <!-- Cálculos de Resumo -->
                        var totalSlots = item.Slots.Count(x => !x.IsExtra);
                        var openSlots = item.Slots.Count(x => x.Status == SlotStatus.Aberto && !x.IsExtra);
                        var extras = item.Slots.Count(x => x.IsExtra);
                        var isSalvador = item.Region == RegionType.Salvador;

                        <div class="col-md-4 col-lg-3 col-xl-2">
                            <div class="card h-100 border-0 shadow-sm card-hover cursor-pointer"
                                 @onclick="() => NavigateToDetails(item.Id)">

                                <!-- Faixa Colorida de Status (Lateral) -->
                                <div class="card-body p-3 position-relative overflow-hidden">
                                    <div class="status-strip @(isSalvador ? "bg-danger" : "bg-warning")"></div>

                                    <!-- Data e Região -->
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <div class="text-center bg-light rounded p-2 border" style="min-width: 50px;">
                                            <span class="d-block h4 fw-bold m-0 line-height-1">@item.Date.Day</span>
                                            <span class="d-block x-small text-uppercase fw-bold text-muted">@item.Date.ToString("ddd")</span>
                                        </div>
                                        <span class="badge @(isSalvador ? "bg-danger" : "bg-warning text-dark") x-small">
                                            @item.Region
                                        </span>
                                    </div>

                                    <!-- Resumo de Vagas -->
                                    <div class="mt-3">
                                        <div class="d-flex justify-content-between align-items-center mb-1">
                                            <span class="text-muted x-small fw-bold">STATUS</span>
                                            @if (openSlots == totalSlots && totalSlots > 0)
                                            {
                                                <span class="text-success x-small fw-bold"><i class="bi bi-check-all"></i> ABERTA</span>
                                            }
                                            else if (openSlots > 0)
                                            {
                                                <span class="text-primary x-small fw-bold">PARCIAL</span>
                                            }
                                            else
                                            {
                                                <span class="text-muted x-small">PLANEJADO</span>
                                            }
                                        </div>

                                        <!-- Barra de Progresso Visual -->
                                        <div class="progress" style="height: 6px;">
                                            <div class="progress-bar bg-success" role="progressbar"
                                                 style="width: @(totalSlots > 0 ? (openSlots * 100 / totalSlots) : 0)%"
                                                 aria-valuenow="@openSlots" aria-valuemin="0" aria-valuemax="@totalSlots"></div>
                                        </div>

                                        <div class="d-flex justify-content-between mt-2 x-small text-muted">
                                            <span><i class="bi bi-person-fill"></i> @totalSlots Instr.</span>
                                            @if (extras > 0)
                                            {
                                                <span class="text-danger fw-bold"><i class="bi bi-lightning-fill"></i> @extras Extra</span>
                                            }
                                        </div>
                                    </div>

                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        }
    }
</div>

<style>
    .cursor-pointer {
        cursor: pointer;
    }

    /* Efeito de Hover no Card */
    .card-hover {
        transition: transform 0.2s, box-shadow 0.2s;
    }

        .card-hover:hover {
            transform: translateY(-3px);
            box-shadow: 0 .5rem 1rem rgba(0,0,0,.15) !important;
        }

    /* Faixa lateral colorida */
    .status-strip {
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 4px;
    }

    .x-small {
        font-size: 0.7rem;
    }

    .line-height-1 {
        line-height: 1;
    }

    .fade-in {
        animation: fadeIn 0.5s ease-in;
    }

    @@keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>