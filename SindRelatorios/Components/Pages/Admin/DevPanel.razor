@page "/dev-panel"
@using Microsoft.AspNetCore.Components.Forms
@using SindRelatorios.Models.Entities.Enums

<PageTitle>Painel do Desenvolvedor</PageTitle>

<div class="container-fluid p-0">

    @if (!IsAuthenticated)
    {
        <div class="d-flex justify-content-center align-items-center" style="height: 70vh;">
            <div class="card border-0 shadow-lg" style="width: 400px;">
                <div class="card-header bg-dark text-white text-center py-3">
                    <h5 class="m-0"><i class="bi bi-terminal-fill me-2"></i>Acesso Restrito</h5>
                </div>
                <div class="card-body p-4">
                    <label class="form-label text-secondary fw-bold small">SENHA DE ADMINISTRADOR</label>
                    <input type="password" class="form-control mb-3" 
                           @bind="PasswordInput" 
                           @onkeydown="@EnterKey" 
                           placeholder="Digite a senha..." />
                    
                    @if (!string.IsNullOrEmpty(LoginMessage))
                    {
                        <div class="alert alert-danger py-2 small text-center fade-in">
                            <i class="bi bi-exclamation-circle me-1"></i> @LoginMessage
                        </div>
                    }

                    <button class="btn btn-dark w-100 fw-bold mt-2" @onclick="TryLogin">
                        Acessar Painel
                    </button>
                    
                    <button class="btn btn-link text-muted w-100 mt-2 text-decoration-none small" 
                            @onclick="Logout">
                        Voltar ao site
                    </button>
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="d-flex align-items-center justify-content-between mb-4 fade-in">
            <div class="d-flex align-items-center gap-3">
                <div class="bg-dark p-2 rounded-3 text-white">
                    <i class="bi bi-kanban-fill fs-4"></i>
                </div>
                
                <div class="btn-group shadow-sm">
                    <button class="btn @(ActiveTab == "Features" ? "btn-dark" : "btn-outline-dark border-0") fw-bold" 
                            @onclick='() => ActiveTab = "Features"'>
                        Roadmap
                    </button>
                    <button class="btn @(ActiveTab == "Suggestions" ? "btn-dark" : "btn-outline-dark border-0") fw-bold d-flex align-items-center" 
                            @onclick='() => ActiveTab = "Suggestions"'>
                        Sugest√µes
                        @if (SuggestionsList.Any())
                        {
                            <span class="badge bg-danger ms-2 rounded-pill">@SuggestionsList.Count</span>
                        }
                    </button>
                </div>
            </div>
            
            <div class="d-flex gap-2">
                <button class="btn btn-outline-danger fw-bold" @onclick="Logout">
                    <i class="bi bi-box-arrow-right me-2"></i> Sair
                </button>
                
                @if(ActiveTab == "Features") 
                {
                    <button class="btn btn-primary shadow-sm fw-bold" @onclick="OpenCreateModal">
                        <i class="bi bi-plus-lg me-2"></i> Nova Feature
                    </button>
                }
            </div>
        </div>

        @if (ActiveTab == "Features")
        {
            <div class="card border-0 shadow-sm fade-in">
                <div class="card-body p-0">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="bg-light text-secondary small">
                            <tr>
                                <th class="ps-4 py-3">T√çTULO</th>
                                <th>STATUS</th>
                                <th>DATA CRIA√á√ÉO</th>
                                <th class="text-end pe-4">A√á√ïES</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in FeaturesList)
                            {
                                <tr>
                                    <td class="ps-4">
                                        <div class="fw-bold text-dark">@item.Title</div>
                                        <small class="text-muted text-truncate d-block" style="max-width: 300px;">
                                            @item.Description
                                        </small>
                                    </td>
                                    <td>
                                        <span class="badge @GetBadgeClass(item.Status) px-3 py-2 rounded-pill border">
                                            @item.Status.ToString()
                                        </span>
                                    </td>
                                    <td class="text-muted small">
                                        @item.CreatedAt.ToString("dd/MM/yyyy")
                                    </td>
                                    <td class="text-end pe-4">
                                        <button class="btn btn-sm btn-outline-primary border-0 me-1" 
                                                title="Editar"
                                                @onclick="() => OpenEditModal(item)">
                                            <i class="bi bi-pencil-fill"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger border-0" 
                                                title="Excluir"
                                                @onclick="() => HandleDelete(item.Id)">
                                            <i class="bi bi-trash-fill"></i>
                                        </button>
                                    </td>
                                </tr>
                            }
                            @if (!FeaturesList.Any())
                            {
                                <tr>
                                    <td colspan="4" class="text-center py-5 text-muted">Nenhuma feature cadastrada.</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        }

        @if (ActiveTab == "Suggestions")
        {
            <div class="card border-0 shadow-sm fade-in border-top border-4 border-info">
                <div class="card-body p-0">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="bg-light text-secondary small">
                            <tr>
                                <th class="ps-4 py-3">SUGEST√ÉO</th>
                                <th style="width: 150px;">DATA</th>
                                <th class="text-end pe-4" style="width: 200px;">A√á√ïES</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in SuggestionsList)
                            {
                                <tr>
                                    <td class="ps-4 py-3">
                                        <p class="m-0 text-dark" style="white-space: pre-wrap;">@item.Content</p>
                                    </td>
                                    <td class="text-muted small">
                                        @item.CreatedAt.ToString("dd/MM/yyyy HH:mm")
                                    </td>
                                    <td class="text-end pe-4">
                                        <button class="btn btn-sm btn-success me-1 fw-bold" 
                                                title="Transformar em Feature" 
                                                @onclick="() => PromoteToFeature(item)">
                                            <i class="bi bi-arrow-up-circle-fill me-1"></i> Promover
                                        </button>
                                        
                                        <button class="btn btn-sm btn-outline-danger border-0" 
                                                title="Descartar"
                                                @onclick="() => DeleteSuggestion(item.Id)">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            }
                            @if (!SuggestionsList.Any())
                            {
                                <tr>
                                    <td colspan="3" class="text-center py-5 text-muted">
                                        <i class="bi bi-inbox-fill fs-1 d-block mb-2 opacity-50"></i>
                                        Nenhuma sugest√£o pendente.
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        }
    }
</div>

@if (ShowModal)
{
    <div class="modal-backdrop fade show"></div>
    
    <div class="modal fade show d-block" tabindex="-1" style="z-index: 10000;">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header bg-dark text-white">
                    <h5 class="modal-title fw-bold">
                        @((IsEditing) ? "Editar Feature" : "Nova Feature")
                    </h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="CloseModal"></button>
                </div>
                <div class="modal-body p-4">
                    <EditForm Model="CurrentFeature" OnValidSubmit="HandleSave">
                        <DataAnnotationsValidator />
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold text-secondary small">T√çTULO</label>
                            <InputText @bind-Value="CurrentFeature.Title" class="form-control" placeholder="Ex: M√≥dulo Financeiro" />
                            <ValidationMessage For="() => CurrentFeature.Title" class="text-danger small" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold text-secondary small">DESCRI√á√ÉO</label>
                            <InputTextArea @bind-Value="CurrentFeature.Description" class="form-control" rows="3" placeholder="Detalhes da funcionalidade..." />
                            <ValidationMessage For="() => CurrentFeature.Description" class="text-danger small" />
                        </div>

                        <div class="mb-4">
                            <label class="form-label fw-bold text-secondary small">STATUS ATUAL</label>
                            <InputSelect @bind-Value="CurrentFeature.Status" class="form-select">
                                <option value="@FeatureStatus.Idea">üí° Ideia / Backlog</option>
                                <option value="@FeatureStatus.InProgress">üöß Em Desenvolvimento</option>
                                <option value="@FeatureStatus.Completed">‚úÖ Conclu√≠do</option>
                            </InputSelect>
                        </div>

                        <div class="d-flex justify-content-end gap-2 pt-3 border-top">
                            <button type="button" class="btn btn-light border px-4" @onclick="CloseModal">Cancelar</button>
                            <button type="submit" class="btn btn-primary px-4 fw-bold">Salvar</button>
                        </div>
                    </EditForm>
                </div>
            </div>
        </div>
    </div>
}

<style>
    .fade-in { animation: fadeIn 0.5s ease-in; }
    @@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .form-control:focus, .form-select:focus { border-color: #3b82f6; box-shadow: none; background-color: #f8fafc; }
</style>